<?xml version="1.0" encoding="UTF-8"?>

<project basedir="." default="all" name="Saxon for the Java platform"
         xmlns:dn="antlib:org.apache.ant.dotnet">
    
    <!-- Build file for Saxon on the Java platform. This build file is designed to be imported
         from build.xml -->
    
	<import file="build-constants.xml"/>   		        
    
	<!-- Import of private Saxonica build file for signing the issued JARs (task private-signjars). -->
	<!-- This can be replaced by a reference to different signing tool -->
	
	<import file="build-j-signer.xml"/>   		        
    
    
    <!-- directory holding Java test drivers -->
    <property name="drivers-j.dir" value="../MyJava/testcode/test"/>		    
		    

    <taskdef resource="com/igormaznitsa/jcp/ant/tasks.properties" classpath="../lib/jcp-5.3.2.jar"/>
    <!-- following locations are relative to the build file -->
        
    <property name="services.dir" value="services"/>
    <property name="temp-src-j.dir" value="${temp.dir}/j/source"/>
    <property name="temp-src-prep-hej.dir" value="${temp.dir}/preprocessed/hej/source"/>
    <property name="temp-src-prep-eej.dir" value="${temp.dir}/preprocessed/eej/source"/>
    <property name="temp-src-prep-pej.dir" value="${temp.dir}/preprocessed/pej/source"/>
    <property name="temp-src-prep-test.dir" value="${temp.dir}/preprocessed/testdriver"/>
    <property name="classes-j.dir" value="${temp.dir}/j/classes"/>
    
    <property name="jar-signer-certificate" value="codesigner.p12"/> 

    <!-- following locations are relative to the destination directory -->
		
    <property name="build-hej.dir" value="${product.dir}/hej"/> 
    <property name="build-pej.dir" value="${product.dir}/pej"/>  
    <property name="build-eej.dir" value="${product.dir}/eej"/> 

    <property name="javadoc.dir" value="${build-resources.dir}/doc/javadoc"/>   
    
    
    <path id="classpath-j">
        <fileset dir="${lib.dir}">
            <include name="*.jar"/>
        </fileset>
    </path>
        
     
    <path id="classpath-samples">
        <fileset dir="${lib.dir}">
            <include name="*.jar"/>
        </fileset>
        <fileset dir="${build-eej.dir}">
            <include name="*.jar"/>
        </fileset>
        <!-- Substitute build-hej.dir if there is no requirement to compile the sample applications
             that depend on Saxon-EE -->
    </path> 


    <target name="create-meta-inf" description="Create contents of META-INF/services files">    
        
        <!-- given the Ant 1.7.0 bug, create the services files here for copying into the JARS -->
        <mkdir dir="${services.dir}/saxon9he/META-INF/services"/>
        <echo file="${services.dir}/saxon9he/META-INF/services/javax.xml.transform.TransformerFactory"
              message="net.sf.saxon.TransformerFactoryImpl"/>
        <mkdir dir="${services.dir}/saxon9he/META-INF/services"/>
        <!-- The peculiar format of these files is due to the bug described at
             http://markmail.org/message/obgfqbnrkuhzl6wl. The correct format is
             just to use the first line: this works for JDK 1.6. But JDK 1.5 incorrectly
             expects a properties file, in the form of the subsequent line. The combination
             works with both Java releases -->
        <!-- See bug 1944. The next 9.5 maintenance release will use the JDK 1.6 format;
             the next full release will drop the XPath services data entirely -->
        <echo file="${services.dir}/saxon9he/META-INF/services/javax.xml.xpath.XPathFactory"
>net.sf.saxon.xpath.XPathFactoryImpl
        </echo>
        
        <!-- dropped from the above:
            http\://java.sun.com/jaxp/xpath/dom:    net.sf.saxon.xpath.XPathFactoryImpl
            http\://saxon.sf.net/jaxp/xpath/om:     net.sf.saxon.xpath.XPathFactoryImpl
        -->

        <mkdir dir="${services.dir}/saxon9pe/META-INF/services"/>
        <echo file="${services.dir}/saxon9pe/META-INF/services/javax.xml.transform.TransformerFactory"
              message="com.saxonica.config.ProfessionalTransformerFactory"/> 
        <echo file="${services.dir}/saxon9pe/META-INF/services/javax.xml.xpath.XPathFactory"
>com.saxonica.config.ProfessionalXPathFactory
        </echo>
        
        <!-- dropped from the above:
            http\://java.sun.com/jaxp/xpath/dom:    com.saxonica.config.ProfessionalXPathFactory
            http\://saxon.sf.net/jaxp/xpath/om:     com.saxonica.config.ProfessionalXPathFactory
            http\://www.xom.nu/jaxp/xpath/xom:      com.saxonica.config.ProfessionalXPathFactory
            http\://jdom.org/jaxp/xpath/jdom:       com.saxonica.config.ProfessionalXPathFactory
            http\://www.dom4j.org/jaxp/xpath/dom4j: com.saxonica.config.ProfessionalXPathFactory
            -->

               
        <mkdir dir="${services.dir}/saxon9ee/META-INF/services"/>
        <echo file="${services.dir}/saxon9ee/META-INF/services/javax.xml.transform.TransformerFactory"
              message="com.saxonica.config.EnterpriseTransformerFactory"/>
        <echo file="${services.dir}/saxon9ee/META-INF/services/javax.xml.xpath.XPathFactory"
>com.saxonica.config.EnterpriseXPathFactory
        </echo>
        <!-- Dropped from the above:
            http\://java.sun.com/jaxp/xpath/dom:    com.saxonica.config.EnterpriseXPathFactory
            http\://saxon.sf.net/jaxp/xpath/om:     com.saxonica.config.EnterpriseXPathFactory
            http\://www.xom.nu/jaxp/xpath/xom:      com.saxonica.config.EnterpriseXPathFactory
            http\://jdom.org/jaxp/xpath/jdom:       com.saxonica.config.EnterpriseXPathFactory
            http\://www.dom4j.org/jaxp/xpath/dom4j: com.saxonica.config.EnterpriseXPathFactory
            -->
<echo file="${services.dir}/saxon9ee/META-INF/services/javax.xml.validation.SchemaFactory"
>com.saxonica.jaxp.SchemaFactoryImpl</echo>     
       <!--<echo file="${services.dir}/saxon9ee/META-INF/services/javax.xml.validation.SchemaFactory"
>com.saxonica.jaxp.SchemaFactoryImpl
http\://www.w3.org/2001/XMLSchema: com.saxonica.jaxp.SchemaFactoryImpl
http\://www.w3.org/XML/XMLSchema: com.saxonica.jaxp.SchemaFactoryImpl
http\://www.w3.org/XML/XMLSchema/v1.0: com.saxonica.jaxp.SchemaFactoryImpl
http\://www.w3.org/XML/XMLSchema/v1.1: com.saxonica.jaxp.SchemaFactoryImpl
</echo>  -->       
    </target>                                  


    
   <!-- <target name="create-edition-properties-j" description="Create the edition.properties files for the three editions of Saxon on Java">
        <mkdir dir="${classes-j.dir}"/>
        <mkdir dir="${classes-j.dir}/he"/>
        <mkdir dir="${classes-j.dir}/pe"/>
        <mkdir dir="${classes-j.dir}/ee"/>
        <echo file="${classes-j.dir}/he/edition.properties"
>config=net.sf.saxon.Configuration
platform=net.sf.saxon.java.JavaPlatform
</echo>
        <echo file="${classes-j.dir}/pe/edition.properties"
>config=com.saxonica.config.ProfessionalConfiguration
platform=com.saxonica.config.JavaPlatformPE
</echo>
        <echo file="${classes-j.dir}/ee/edition.properties"
>config=com.saxonica.config.EnterpriseConfiguration
platform=com.saxonica.config.JavaPlatformPE
</echo>   
    </target>    -->

    <target name="prepare-j" depends="create-meta-inf">              
    </target>       



    <target name="copysource-development-j" description="Copy relevant source files from development directory">
        <copy todir="${temp-src-j.dir}">
          <!--
    <target name="prepare-j" depends="create-meta-inf"/><fileset dir="${source-hej.dir}">
            <include name="net/sf/saxon/**/*.java"/>
            <include name="javax/xml/xquery/*.java"/>
            <exclude name="**/dotnet/**"/>
            <include name="net/sf/saxon/**/package.html"/>
          </fileset>
          <fileset dir="${source-eej.dir}">
            <include name="com/saxonica/**/*.java"/>
            <exclude name="com/saxonica/config/DotNetExtensionFunctionFactory.java"/>
            <exclude name="com/saxonica/config/DotNetExtensionLibrary.java"/>
            <exclude name="com/saxonica/config/DotNetPlatformPE.java"/>
            <exclude name="com/saxonica/expr/DotNetExtensionFunctionCall.java"/>
            <include name="com/saxonica/**/package.html"/>
          </fileset>                                -->
          <fileset dir="${development-data.dir}">
            <include name="**/*.*"/>
          </fileset>          
        </copy>            
    </target>



    <target name="copysrc-hej">
        <mkdir dir="${temp-src-j.dir}/hej"/>
        <copy todir="${temp-src-j.dir}/hej">
          <fileset dir="${source-hej.dir}">
            <include name="net/sf/saxon/**/*.java"/>
            <include name="javax/xml/xquery/*.java"/>
            <exclude name="**/dotnet/**"/>
            <include name="net/sf/saxon/**/package.html"/>
          </fileset>
          <fileset dir="${development-data.dir}">
            <include name="**/*.*"/>
          </fileset>
        </copy>
    </target>

    <target name="copysrc-pej">
        <mkdir dir="${temp-src-j.dir}/pej"/>
        <copy todir="${temp-src-j.dir}/pej">
          <fileset dir="${source-hej.dir}">
            <include name="net/sf/saxon/**/*.java"/>
            <include name="javax/xml/xquery/*.java"/>
            <exclude name="**/dotnet/**"/>
            <exclude name="net/sf/saxon/option/expath/zip/**"/>  
            <include name="net/sf/saxon/**/package.html"/>
	    <exclude name="net/sf/saxon/option/expath/zip/**" />		
          </fileset>
          <fileset dir="${source-eej.dir}">
            <include name="com/saxonica/**/*.java"/>
            <exclude name="com/saxonica/testdriver/**/*.java"/>
            <exclude name="com/saxonica/jaxp/*.java"/>
            <exclude name="com/saxonica/config/EnterpriseConfiguration.java" />
            <exclude name="com/saxonica/config/ee/**" />
            <exclude name="com/saxonica/stream/**" />
            <exclude name="com/saxonica/schema/**" />
            <exclude name="com/saxonica/bytecode/**" />
            <exclude name="com/saxonica/expr/ee/**" />
            <exclude name="com/saxonica/update/**/*.java"/>
            <exclude name="com/saxonica/validate/**/*.java"/>
            <exclude name="com/saxonica/expr/CastToUnion.java"/>
            <exclude name="com/saxonica/expr/CastableToUnion.java"/>
            <exclude name="com/saxonica/expr/DotNetExtensionFunctionCall.java"/>
            <exclude name="com/saxonica/config/DotNetExtensionLibrary.java"/>
            <exclude name="com/saxonica/config/DotNetExtensionFunctionFactory.java"/>
            <exclude name="com/saxonica/config/DotNetPlatformPE.java"/>
            <exclude name="com/saxonica/Validate.java"/>
            <exclude name="com/saxonica/config/EnterpriseTransformerFactory.java"/>
            <exclude name="com/saxonica/config/EnterpriseXPathFactory.java"/>
            <exclude name="com/saxonica/config/DynamicLoaderEE.java"/>
            <exclude name="com/saxonica/config/StandardSchemaResolver.java"/>
            <exclude name="com/saxonica/jaxp/SchemaFactoryImpl11.java"/>
          </fileset>
          <fileset dir="${development-data.dir}">
            <include name="**/*.*"/>
          </fileset>
        </copy>
    </target>

   <target name="copysrc-eej">
        <mkdir dir="${temp-src-j.dir}/eej"/>
        <copy todir="${temp-src-j.dir}/eej">
          <fileset dir="${source-hej.dir}">
            <include name="net/sf/saxon/**/*.java"/>
            <include name="javax/xml/xquery/*.java"/>
            <exclude name="**/dotnet/**"/>
            <exclude name="net/sf/saxon/option/expath/zip/**"/>  
            <include name="net/sf/saxon/**/package.html"/>
	    <exclude name="net/sf/saxon/option/expath/zip/**" />		
          </fileset>
          <fileset dir="${source-eej.dir}">
            <include name="com/saxonica/**/*.java"/>
            <exclude name="com/saxonica/testdriver/**/*.java"/>
            <!--<exclude name="com/saxonica/jaxp/*.java"/>-->
            <!--<exclude name="com/saxonica/config/pe/**" />-->
            <!--<exclude name="com/saxonica/config/DotNetVerifier.java"/>-->
            <exclude name="com/saxonica/config/DotNetExtensionFunctionFactory.java"/>
            <exclude name="com/saxonica/config/DotNetExtensionLibrary.java"/>
            <exclude name="com/saxonica/config/DotNetPlatformPE.java"/>
            <exclude name="com/saxonica/expr/DotNetExtensionFunctionCall.java"/>
            <include name="com/saxonica/**/package.html"/>
          </fileset>
          <fileset dir="${development-data.dir}">
            <include name="**/*.*"/>
          </fileset>
        </copy>
    </target>

    <target name="preprocess-hej" depends="copysrc-hej">
        <preprocess
            source="${temp-src-j.dir}/hej"
            destination="${temp-src-prep-hej.dir}"
            verbose="true">
        <global name="EE" value="false"/>
        <global name="PE" value="false"/>
        <global name="DOTNET" value="false"/>
       </preprocess>
       <replaceregexp match="import com\.saxonica(.*)" replace="" flags="g">
            <fileset dir="${temp-src-prep-hej.dir}"  includes="**/*.java" />
        </replaceregexp>
       <replaceregexp file="${temp-src-prep-hej.dir}/net/sf/saxon/Configuration.java" match="import net\.sf\.saxon\.dotnet\.DotNetPlatform(.*)" replace="" byline="yes" />
       <replaceregexp file="${temp-src-prep-hej.dir}//net/sf/saxon/Configuration.java" match="import com\.saxonica\.config\.DotNetPlatformPE(.*)" replace="" byline="yes" />
       <replaceregexp file="${temp-src-prep-hej.dir}/net/sf/saxon/Configuration.java" match="import com\.saxonica\.config\.EnterpriseConfiguration(.*)" replace="" byline="yes" />
        <replaceregexp file="${temp-src-prep-hej.dir}/net/sf/saxon/Configuration.java" match="import com\.saxonica\.config\.ProfessionalConfiguration(.*)" replace="" byline="yes" />
       <replaceregexp file="${temp-src-prep-hej.dir}/net/sf/saxon/Configuration.java" match="import com\.saxonica\.config\.JavaPlatformPE(.*)" replace="" byline="yes" />
        <echo>Preprocessing hej complete!</echo>
    </target>

    <target name="preprocess-android" depends="copysrc-eej">
        <preprocess
            source="${temp-src-j.dir}/eej"
            destination="${temp-src-prep-hej.dir}"
            verbose="true">
            <global name="HOF" value="true"/>
            <global name="STREAM" value="true"/>
       </preprocess>
        <replaceregexp match="import com\.saxonica\.bytecode(.*)" replace="" byline="yes">
            <fileset dir="${temp-src-prep-hej.dir}\net" includes="**/*.java" />
        </replaceregexp>
        <replaceregexp match="import com\.saxonica\.bytecode(.*)" replace="" byline="yes">
            <fileset dir="${temp-src-prep-hej.dir}\com" includes="**/*.java" />
        </replaceregexp>
         <delete dir="${temp-src-prep-hej.dir}/com/saxonica/bytecode" />
        <delete dir="${temp-src-prep-hej.dir}/com/saxonica/testdriver" />
       <echo>Preprocessing Android complete!</echo>
    </target>

    <target name="preprocess-pej" depends="copysrc-pej">
        <preprocess
            source="${temp-src-j.dir}/pej"
            destination="${temp-src-prep-pej.dir}"
            verbose="true">
        <global name="DOTNET" value="false"/>
        <global name="PE" value="true"/>
        <global name="HOF" value="true"/>
        <global name="EE" value="false"/>
       </preprocess>
       <!-- <replaceregexp file="${temp-src-prep-pej.dir}/net/sf/saxon/Configuration.java" match="import net\.sf\.saxon\.java\.JavaPlatform(.*)" replace="" byline="yes" /> -->
       <replaceregexp file="${temp-src-prep-pej.dir}/net/sf/saxon/Configuration.java" match="import net\.sf\.saxon\.dotnet\.DotNetPlatform(.*)" replace="" byline="yes" />
       <replaceregexp file="${temp-src-prep-pej.dir}/net/sf/saxon/Configuration.java" match="import com\.saxonica\.config\.DotNetPlatformPE(.*)" replace="" byline="yes" />
       <replaceregexp file="${temp-src-prep-pej.dir}/net/sf/saxon/Configuration.java" match="import com\.saxonica\.config\.EnterpriseConfiguration(.*)" replace="" byline="yes" />
       <replaceregexp file="${temp-src-prep-pej.dir}/net/sf/saxon/functions/ConstructorFunctionLibrary.java" match="import com\.saxonica\.expr.CastToUnion(.*)" replace="" byline="yes" />

       <replaceregexp match="import com\.saxonica\.bytecode(.*)" replace="" flags="g"  byline="true">
	     <fileset dir="${temp-src-prep-pej.dir}"  includes="**/*.java" />
       </replaceregexp>
       <replaceregexp match="import com\.saxonica\.config\.ee(.*)" replace="" flags="g">
	     <fileset dir="${temp-src-prep-pej.dir}"  includes="**/*.java" />
       </replaceregexp>
        <replaceregexp match="import com\.saxonica\.schema(.*)" replace="" flags="g">
	     <fileset dir="${temp-src-prep-pej.dir}" includes="**/*.java" />
       </replaceregexp>
        <replaceregexp match="import com\.saxonica\.stream(.*)" replace="" flags="g">
	     <fileset dir="${temp-src-prep-pej.dir}" includes="**/*.java" />
       </replaceregexp>
        <replaceregexp match="import com\.saxonica\.update(.*)" replace="" flags="g">
	     <fileset dir="${temp-src-prep-pej.dir}" includes="**/*.java" />
       </replaceregexp>
        <replaceregexp match="import com\.saxonica\.expr\.ee(.*)" replace="" flags="g">
	     <fileset dir="${temp-src-prep-pej.dir}" includes="**/*.java" />
       </replaceregexp>
       <echo>Preprocessing eej complete!</echo>
    </target>

    <target name="preprocess-eej" depends="copysrc-eej">
        <preprocess
            source="${temp-src-j.dir}/eej"
            destination="${temp-src-prep-eej.dir}"
            verbose="true">
        <global name="EE" value="true"/>
        <global name="PE" value="true"/>
       <global name="STREAM" value="true"/>
       <global name="HOF" value="true"/>
       <global name="BYTECODE" value="true"/>
       <global name="SCHEMA" value="true"/>
        <global name="DOTNET" value="false"/>
       </preprocess>
       <replaceregexp file="${temp-src-prep-eej.dir}/net/sf/saxon/Configuration.java" match="import net\.sf\.saxon\.dotnet\.DotNetPlatform(.*)" replace="" byline="yes" />
       <replaceregexp file="${temp-src-prep-eej.dir}/net/sf/saxon/Configuration.java" match="import com\.saxonica\.config\.DotNetPlatform(.*)" replace="" byline="yes" />
             <!--<replaceregexp match="import com\.saxonica\.bytecode(.*)" replace="" flags="g"  byline="true">
	     <fileset dir="${temp-src-prep-eej.dir}"  includes="**/*.java" />
       </replaceregexp>   -->
       <echo>Preprocessing eej complete!</echo>
    </target>
        
    <target name="compile-hej" description="Compile Saxon classes for the Java opensource product."
            depends="copysource-development-j, preprocess-hej">
        <mkdir dir="${classes-j.dir}"/>

        <javac debug="${build.debug}" debuglevel="${build.debuglevel}" 
            deprecation="${build.deprecation}" destdir="${classes-j.dir}"
            optimize="${build.optimize}" srcdir="${temp-src-prep-hej.dir}" source="${build.compiler.source}"
            target="${build.compiler.target}"
            fork="true"
            memoryinitialsize="256m"
            memorymaximumsize="256m">

            <include name="net/**"/>
            <exclude name="net/sf/saxon/option/**/*.java"/>
            <include name="javax/xml/xquery/**"/>
            <exclude name="com/saxonica/**"/>
            
            <!--<exclude name="**/dotnet/**"/>-->
            <!--<exclude name="com/saxonica/validate/DotNetVerifier.java"/>-->
            <classpath>
                <path refid="classpath-j"/>
            </classpath>
        </javac>
    </target>

        <target name="compile-eej" description="Compile Saxon classes for the Java enterprise edition."
            depends="copysource-development-j, preprocess-eej">
        <mkdir dir="${classes-j.dir}"/>

        <javac debug="${build.debug}" debuglevel="${build.debuglevel}"
            deprecation="${build.deprecation}" destdir="${classes-j.dir}"
            optimize="${build.optimize}" srcdir="${temp-src-prep-eej.dir}" source="${build.compiler.source}"
            target="${build.compiler.target}"
            fork="true"
            memoryinitialsize="256m"
            memorymaximumsize="256m">

            <include name="net/**"/>
            <include name="javax/xml/xquery/**"/>
            <include name="com/saxonica/**"/>

            <!--<exclude name="**/dotnet/**"/>-->
            <!--<exclude name="com/saxonica/validate/DotNetVerifier.java"/>-->
            <classpath>
                <path refid="classpath-j"/>
            </classpath>
        </javac>
    </target>

        <target name="compile-pej" description="Compile Saxon classes for the Java professional edition."
            depends="copysource-development-j, preprocess-pej">
        <mkdir dir="${classes-j.dir}"/>

        <javac debug="${build.debug}" debuglevel="${build.debuglevel}"
            deprecation="${build.deprecation}" destdir="${classes-j.dir}"
            optimize="${build.optimize}" srcdir="${temp-src-prep-pej.dir}" source="${build.compiler.source}"
            target="${build.compiler.target}"
            fork="true"
            memoryinitialsize="256m"
            memorymaximumsize="256m">

            <include name="net/**"/>
            <include name="javax/xml/xquery/**"/>
            <include name="com/saxonica/**"/>

            <!--<exclude name="**/dotnet/**"/>-->
            <!--<exclude name="com/saxonica/validate/DotNetVerifier.java"/>-->
            <classpath>
                <path refid="classpath-j"/>
            </classpath>
        </javac>
    </target>

<target name="unpack">
    <!-- saxon9-unpack.jar -->
    <jar basedir="${classes-j.dir}" compress="${build.compress}" jarfile="${product.dir}/hej/saxon9-unpack.jar" update="true">
        <include name="com/saxonica/ptree/PTreeReader.class"/>
        <include name="com/saxonica/ptree/PTreeReader$PTreeException.class"/>
        <include name="com/saxonica/ptree/TextMangler.class"/>
        <include name="com/saxonica/ptree/TextObfuscator.class"/>
        <include name="com/saxonica/ptree/PackageURIResolver.class"/>
    </jar>
</target>
          
    <target name="jar-hej" description="Create Saxon-HE jar files for Java" depends="compile-hej, unpack">
        <mkdir dir="${product.dir}/hej"/>
        <mkdir dir="${classes-j.dir}/he"/>

        <jar basedir="${classes-j.dir}" compress="${build.compress}" jarfile="${product.dir}/hej/saxon9he.jar">
            <include name="net/**/*.class"/>
            <exclude name="net/sf/saxon/option/**/*.class"/>
            <!--<exclude name="**/javax/**/*.class"/>
            <exclude name="**/xpath/**/*.class"/>
            <exclude name="**/xqj/**/*.class"/>-->
            <include name="javax/xml/xquery/*.class"/>
            <include name="META-INF/**"/>
            <manifest>
                <attribute name="Project-Name" value="Saxon-HE"/>
                <attribute name="Main-Class" value="net.sf.saxon.Transform"/>
            </manifest>
            <metainf dir="${services.dir}/saxon9he/META-INF"/>
            <!--<metainf dir="${services.dir}/saxon9-xpath/META-INF"/>-->
            <!--
            <service type="javax.xml.transform.TransformerFactory"
                provider="net.sf.saxon.TransformerFactoryImpl"/>
            -->    
        </jar>
        
        <!-- add edition.properties -->
        <!-- <jar basedir="${classes-j.dir}/he" compress="${build.compress}" jarfile="${product.dir}/hej/saxon9he.jar" update="true">
            <include name="edition.properties"/>
        </jar> -->
        
        <!-- add data files -->
        <jar basedir="${development-data.dir}" compress="${build.compress}" jarfile="${product.dir}/hej/saxon9he.jar" update="true">
            <include name="**"/>
        </jar>
        
        <!-- saxon9-unpack.jar -->
        <jar basedir="${classes-j.dir}" compress="${build.compress}" jarfile="${product.dir}/hej/saxon9-unpack.jar" update="true">
            <include name="com/saxonica/ptree/PTreeReader.class"/>
            <include name="com/saxonica/ptree/PTreeReader$PTreeException.class"/>
            <include name="com/saxonica/ptree/TextMangler.class"/>
            <include name="com/saxonica/ptree/TextObfuscator.class"/>
            <include name="com/saxonica/ptree/PackageURIResolver.class"/>
        </jar>

        

    </target>
    
    <target name="jar-pej" description="Create Saxon-PE jar files for Java" depends="compile-pej, unpack">
        <mkdir dir="${product.dir}/pej"/>
        <mkdir dir="${classes-j.dir}/pe"/>
        
        <copy todir="${product.dir}/pej">
          <fileset dir="${product.dir}/hej">
            <include name="saxon9-unpack.jar"/>
          </fileset>
        </copy> 
              
        <jar basedir="${classes-j.dir}" compress="${build.compress}" jarfile="${product.dir}/pej/saxon9pe.jar">
            <include name="net/**/*.class"/>
            <exclude name="net/sf/saxon/ant/*.class"/>
            <exclude name="**/sql/**/*.class"/>
            <include name="com/saxonica/**/*.class"/>
            <exclude name="com/saxonica/bytecode/**/*.class"/>
            <exclude name="com/saxonica/fsa/**/*.class"/>
            <exclude name="com/saxonica/jaxp/**/**/*.class"/>
            <exclude name="com/saxonica/schema/**/*.class"/>
            <exclude name="com/saxonica/sdoc/**/*.class"/>
            <exclude name="com/saxonica/stream/**/*.class"/>
            <exclude name="com/saxonica/update/**/*.class"/>
            <exclude name="com/saxonica/validate/**/*.class"/>
            <exclude name="com/saxonica/expr/CastToUnion.class"/>
            <exclude name="com/saxonica/expr/CastableToUnion.class"/>
            <exclude name="com/saxonica/expr/CastToList.class"/>
            <exclude name="com/saxonica/expr/CastableToList.class"/>
            <exclude name="com/saxonica/Validate.class"/>
            <exclude name="com/saxonica/CompileStylesheet.class"/>
            <exclude name="com/saxonica/CompileStylesheet$TracingObjectOutputStream.class"/>
            <exclude name="com/saxonica/config/EnterpriseConfiguration.class"/>
            <exclude name="com/saxonica/config/EnterpriseConfiguration$SurrogateSchema.class"/>
            <exclude name="com/saxonica/config/EnterpriseTransformerFactory.class"/>
            <exclude name="com/saxonica/config/EnterpriseXPathFactory.class"/>
            <exclude name="com/saxonica/extra/StaticQueryContextEE.class"/>
            <exclude name="com/saxonica/extra/OptimizerEE.class"/>
            <exclude name="com/saxonica/extra/GeneralComparisonEE.class"/>
            <exclude name="com/saxonica/extra/MultithreadedContextMappingIterator.class"/>
            <exclude name="com/saxonica/extra/MultithreadedForEach.class"/>
            <include name="javax/xml/xquery/*.class"/>
            <manifest>
                <attribute name="Project-Name" value="Saxon-PE"/>
                <attribute name="Main-Class" value="net.sf.saxon.Transform"/>
            </manifest>
            <metainf dir="${services.dir}/saxon9pe/META-INF"/>

        </jar>
        <!-- <jar basedir="${classes-j.dir}/pe" compress="${build.compress}" jarfile="${product.dir}/pej/saxon9pe.jar" update="true">
            <include name="edition.properties"/>
        </jar>  -->
        <jar basedir="${classes-j.dir}" compress="${build.compress}" jarfile="${product.dir}/pej/saxon9-sql.jar">
            <include name="net/sf/saxon/option/sql/*.class"/>
        </jar>
        <jar basedir="${development-data.dir}" compress="${build.compress}" jarfile="${product.dir}/pej/saxon9pe.jar" update="true">
            <include name="**"/>
        </jar>

    </target>
    
    <target name="jar-eej" description="Create Saxon-EE jar files for Java" depends="compile-eej, unpack">
        <mkdir dir="${product.dir}/eej"/>
        <mkdir dir="${classes-j.dir}/ee"/>
        
        <copy todir="${product.dir}/eej">
          <fileset dir="${product.dir}/pej">
            <include name="saxon9-sql.jar"/>
            <include name="saxon9-unpack.jar"/>
          </fileset>
        </copy>
        
        <!-- Build EEJ using jarjar to rename the ASM classes into a different package name, to allow coexistence with
             other ASM versions -->
        
        <taskdef name="jarjar" classname="com.tonicsystems.jarjar.JarJarTask" classpath="../lib/jarjar-1.1.jar"/>
        <jarjar basedir="${classes-j.dir}" compress="${build.compress}" jarfile="${product.dir}/eej/saxon9ee.jar">
            <include name="net/**/*.class"/>
            <exclude name="net/sf/saxon/ant/*.class"/>
            <exclude name="**/sql/**/*.class"/>
            <include name="com/saxonica/**/*.class"/>
            <include name="javax/xml/xquery/*.class"/>
            <rule pattern="org.objectweb.**" result="com.saxonica.objectweb.@1"/>
            <manifest>
                <attribute name="Project-Name" value="Saxon-EE"/>
                <attribute name="Main-Class" value="net.sf.saxon.Transform"/>
            </manifest>
            <metainf dir="${services.dir}/saxon9ee/META-INF"/> 
        <!-- </jar> -->
        </jarjar>
        <!-- <jar compress="${build.compress}" jarfile="${product.dir}/eej/saxon9ee.jar" update="true"> -->
        <jarjar compress="${build.compress}" jarfile="${product.dir}/eej/saxon9ee.jar" update="true">
            <zipfileset src="${lib.dir}/asm-3.3.1.jar"/>
            <zipfileset src="${lib.dir}/asm-analysis-3.3.1.jar"/>
            <zipfileset src="${lib.dir}/asm-commons-3.3.1.jar"/>
            <zipfileset src="${lib.dir}/asm-tree-3.3.1.jar"/>
            <zipfileset src="${lib.dir}/asm-util-3.3.1.jar"/>
            <rule pattern="org.objectweb.**" result="com.saxonica.objectweb.@1"/>
        </jarjar>
                  
        <!--<jar basedir="${classes-j.dir}/ee" compress="${build.compress}" jarfile="${product.dir}/eej/saxon9ee.jar" update="true">
            <include name="edition.properties"/>
        </jar>      -->
        <jar basedir="${development-data.dir}" compress="${build.compress}" jarfile="${product.dir}/eej/saxon9ee.jar" update="true">
            <include name="**"/>
        </jar>

    </target>
    
    <target name="samples-j" description="Copy and Compile Java Samples"
    				depends="jar-eej, samples-common">
      <mkdir dir="${product.dir}/resources/samples/java"/>
      <mkdir dir="${product.dir}/resources/samples/java/classes"/>
      <copy todir="${product.dir}/resources/samples/java">
        <fileset dir="${samples.dir}/java">
          <include name="ApplyXPathJAXP.java"/>
          <include name="ExampleContentHandler.java"/>
          <include name="JDOMExample.java"/>
          <include name="PullExamples.java"/>
          <include name="QueryAPIExamples.java"/>
          <include name="QuickValidator.java"/>
          <include name="S9APIExamples.java"/>
          <include name="SaxonServlet.java"/>
          <include name="SaxonSAServlet.java"/>
          <include name="SchemaValidatorExample.java"/>
          <include name="SchemaValidatorHandlerExample.java"/>
          <include name="TraxExamples.java"/>
          <include name="XMarkBenchmark.java"/>
          <include name="XPathExample.java"/>
          <include name="XPathExampleDOM.java"/>
          <include name="XPathExampleSA.java"/>
          <include name="XPathExampleServlet.java"/>
          <include name="XQJExamples.java"/>
        </fileset>
      </copy>
        <javac debug="true" debuglevel="${build.debuglevel}" 
			      destdir="${product.dir}/resources/samples/java/classes"
            srcdir="${product.dir}/resources/samples/java" 
            source="${build.compiler.source}"
            target="${build.compiler.target}"
            includeantruntime="false">
        <include name="*.java"/>    
        <classpath>
            <path refid="classpath-samples"/>
        </classpath>
      </javac>            
    </target>
    
    <target name="preprocess-testdriver-j">
        <mkdir dir="${temp-src-prep-test.dir}/hej/com/saxonica/testdriver"/>
        <mkdir dir="${temp-src-prep-test.dir}/pej/com/saxonica/testdriver"/>
        <mkdir dir="${temp-src-prep-test.dir}/eej/com/saxonica/testdriver"/>
        <copy todir="${temp-src-prep-test.dir}/hej/com/saxonica/testdriver">
            <fileset dir="${source-eej.dir}/com/saxonica/testdriver">
                <exclude name="com/saxonica/testdriver/XQueryTestSuiteDriver.java"/> 
                <exclude name="com/saxonica/testdriver/XsltTestSuiteDriver.java"/>
                <exclude name="com/saxonica/testdriver/XQTSModuleURIResolver.java"/> 
                <exclude name="com/saxonica/testdriver/XQTSCollectionURIResolver.java"/> 
                <exclude name="com/saxonica/testdriver/SchemaTestSuiteDriver.java"/> 
            </fileset>
        </copy>
        
        <copy todir="${temp-src-prep-test.dir}/pej/com/saxonica/testdriver">
            <fileset dir="${source-eej.dir}/com/saxonica/testdriver"> 
                <exclude name="com/saxonica/testdriver/XsltTestSuiteDriver.java"/>
                <exclude name="com/saxonica/testdriver/XQTSModuleURIResolver.java"/> 
                <exclude name="com/saxonica/testdriver/XQTSCollectionURIResolver.java"/> 
                <exclude name="com/saxonica/testdriver/SchemaTestSuiteDriver.java"/> 
            </fileset>
        </copy>
        
        <copy todir="${temp-src-prep-test.dir}/eej/com/saxonica/testdriver">
            <fileset dir="${source-eej.dir}/com/saxonica/testdriver" />
            
        </copy>
        <preprocess
            source="${source-eej.dir}/com/saxonica/testdriver"
            destination="${temp-src-prep-test.dir}/hej/com/saxonica/testdriver"
            verbose="true">
            <global name="EE" value="false"/>
            <global name="PE" value="false"/>
            <global name="OPT" value="false"/>
            <global name="DOTNET" value="false"/>
        </preprocess>
        <replaceregexp match="import com\.saxonica\.config\.EnterpriseConfiguration(.*)" replace="" flags="g">
            <fileset dir="${temp-src-prep-test.dir}/hej/com/saxonica/testdriver"  includes="**/*.java" />
        </replaceregexp>
        <replaceregexp match="import com\.saxonica(.*)" replace="" flags="g">
            <fileset file="${temp-src-prep-test.dir}/hej/com/saxonica/testdriver/Environment.java"  includes="**/*.java" />
        </replaceregexp>
        <replaceregexp match="import net\.sf\.saxon\.option(.*)" replace="" flags="g" byline="true">
            <fileset dir="${temp-src-prep-test.dir}/hej/com/saxonica/testdriver"  includes="**/*.java" />
        </replaceregexp>
        <replaceregexp match="import com\.saxonica\.config\.ProfessionalConfiguration(.*)" replace="" flags="g">
            <fileset dir="${temp-src-prep-test.dir}/hej/com/saxonica/testdriver"  includes="**/*.java" />
        </replaceregexp>        
        <replaceregexp match="import com\.saxonica\.config\.EnterpriseTransformerFactory(.*)" replace="" flags="g">
            <fileset dir="${temp-src-prep-test.dir}/hej/com/saxonica/testdriver"  includes="**/*.java" />
        </replaceregexp>                
        <delete file="${temp-src-prep-test.dir}/hej/com/saxonica/testdriver/SchemaTestSuiteDriver.java" />
        <delete file="${temp-src-prep-test.dir}/hej/com/saxonica/testdriver/UpdateTestSuiteDriver.java" />
        <delete file="${temp-src-prep-test.dir}/hej/com/saxonica/testdriver/XQueryTestSuiteDriver.java" />
        <delete file="${temp-src-prep-test.dir}/hej/com/saxonica/testdriver/XsltTestSuiteDriver.java" />
        <delete file="${temp-src-prep-test.dir}/hej/com/saxonica/testdriver/XMarkBenchmark.java" />
        <echo>Preprocessing test-driver-hej complete!</echo>
        
        <preprocess
            source="${source-eej.dir}/com/saxonica/testdriver"
            destination="${temp-src-prep-test.dir}/pej/com/saxonica/testdriver"
            verbose="true">
            <global name="EE" value="false"/>
            <global name="PE" value="true"/>
            <global name="OPT" value="true"/>
            <global name="DOTNET" value="false"/>
        </preprocess>
        <replaceregexp match="import com\.saxonica\.config\.EnterpriseConfiguration(.*)" replace="" flags="g">
            <fileset dir="${temp-src-prep-test.dir}/pej/com/saxonica/testdriver"  includes="**/*.java" />
        </replaceregexp>    
        <replaceregexp match="import com\.saxonica\.config\.EnterpriseTransformerFactory(.*)" replace="" flags="g">
            <fileset dir="${temp-src-prep-test.dir}/pej/com/saxonica/testdriver"  includes="**/*.java" />
        </replaceregexp>                
        <delete file="${temp-src-prep-test.dir}/pej/com/saxonica/testdriver/SchemaTestSuiteDriver.java" />
        <delete file="${temp-src-prep-test.dir}/pej/com/saxonica/testdriver/UpdateTestSuiteDriver.java" />
        <delete file="${temp-src-prep-test.dir}/pej/com/saxonica/testdriver/XQueryTestSuiteDriver.java" />
        <!--<delete file="${temp-src-prep-test.dir}/pej/XQueryTestSuiteDriver.java" />-->        
        <echo>Preprocessing test-driver-pej complete!</echo>
        
        <preprocess
            source="${source-eej.dir}/com/saxonica/testdriver"
            destination="${temp-src-prep-test.dir}/eej/com/saxonica/testdriver"
            verbose="true">
            <global name="EE" value="true"/>
            <global name="PE" value="true"/>
            <global name="OPT" value="true"/>
            <global name="DOTNET" value="false"/>
        </preprocess>
        <echo>Preprocessing test-driver-pej complete!</echo>
    </target>
    
    <target name="testdrivers-j" description="Copy Java Test Drivers">
    	<mkdir dir="${product.dir}/resources/drivers/java"/>
    	<mkdir dir="${product.dir}/resources/drivers/java/classes"/>
    	<copy todir="${product.dir}/resources/drivers/java">
    	  <fileset dir="${source-eej.dir}">
    	    <include name="com/saxonica/testdriver/XQueryTestSuiteDriver.java"/> 
    	    <include name="com/saxonica/testdriver/XsltTestSuiteDriver.java"/>
    	    <include name="com/saxonica/testdriver/Xslt30TestSuiteDriver.java"/>
    	    <include name="com/saxonica/testdriver/TestDriver.java"/>
    	    <include name="com/saxonica/testdriver/Environment.java"/>
    	    <include name="com/saxonica/testdriver/ErrorCollector.java"/>
    	    <include name="com/saxonica/testdriver/FotsResultsDocument.java"/>
    	    <include name="com/saxonica/testdriver/ResultsAssertion.java"/>
    	    <include name="com/saxonica/testdriver/ResultsDocument.java"/>
    	    <include name="com/saxonica/testdriver/Spec.java"/>
    	    <include name="com/saxonica/testdriver/TestOutcome.java"/>
    	    <include name="com/saxonica/testdriver/Xslt30ResultsDocument.java"/>    	      
    	    <include name="com/saxonica/testdriver/FOTestSuiteDriver.java"/> 
    	    <include name="com/saxonica/testdriver/CanonicalXML.java"/> 
    	    <include name="com/saxonica/testdriver/XQTSModuleURIResolver.java"/> 
    	    <include name="com/saxonica/testdriver/XQTSCollectionURIResolver.java"/> 
    	    <include name="com/saxonica/testdriver/SchemaTestSuiteDriver.java"/> 
          </fileset>
        </copy>
        <javac debug="true" debuglevel="${build.debuglevel}" 
			      destdir="${product.dir}/resources/drivers/java/classes"
            srcdir="${product.dir}/resources/drivers/java" 
            source="${build.compiler.source}"
            target="${build.compiler.target}">
          <include name="**/*.java"/>    
          <classpath>
            <path refid="classpath-samples"/>
          </classpath>
        </javac>
    </target>           
    
                  
    <target name="product-javadoc" description="Generate Javadoc." depends="copysource-development-j, preprocess-eej">
        <javadoc bottom="Copyright (c) 2004-2013 Saxonica Limited. All rights reserved."
            destdir="${javadoc.dir}" doctitle="Saxon9 Java API Documentation"
            noindex="false" notree="false" access="protected"
            maxmemory="512M" source="1.5">
            <packageset dir="${temp-src-prep-eej.dir}">
                <include name="net/**"/>
                <include name="com/**"/>
                <include name="javax/xml/query/**"/>
                <exclude name="com/saxonica/testdriver/**"/>
                <exclude name="**/dotnet/**"/>
                <exclude name="**/DotNetVerifier.java"/>
            </packageset>
            <packageset dir="${repository}/lib/xqj-final/ri/src"/>
            <classpath>
                <path refid="classpath-j"/>
            </classpath>
            
            <link href="http://download.oracle.com/javase/6/docs/api/"/>
            <link href="http://www.xom.nu/apidocs/"/>
            
            <group title="s9api Interface" packages="net.sf.saxon.s9api"/>
            <group title="Other Interfaces">
                <package name="net.sf.saxon"/>              
                <package name="net.sf.saxon.lib"/>
                <package name="net.sf.saxon.om"/>
                <package name="net.sf.saxon.query"/>
                <package name="net.sf.saxon.sxpath"/>
                <package name="net.sf.saxon.value"/>
                <package name="net.sf.saxon.type"/>
                <package name="net.sf.saxon.xpath"/>
                <package name="net.sf.saxon.xqj"/>
                <package name="com.saxonica.config"/>
                <package name="com.saxonica.jaxp"/>
                <package name="com.saxonica.schema"/>
                
            </group>
            <group title="External Interfaces">
                <package name="javax.xml.xquery"/>
            </group>
 
            
        </javadoc>
        <copy file="${userdoc.dir}/fixed/javadoc/stylesheet.css"
              tofile="${javadoc.dir}/stylesheet.css"
              overwrite="true"/>
    </target>


    <target name="signjars" depends="jar-hej, jar-pej, jar-eej, maven, private-signjars" description="Sign all JAR files">
        <!-- If the private-signjars task is not available, simply delete the dependency -->
    </target>
    
                    
    <target name="j" depends="signjars"
        description="Generate Saxon (all three editions) for the Java platform"/>
        
    <target name="release-j" description="Create .ZIP files for release"
        depends="j"
        >  <!-- , test-j -->
      <mkdir dir="${issue.dir}"/> 
      <zip zipfile="${issue.dir}/SaxonHE${versionh}J.zip">
        <fileset dir="${product.dir}/hej"/>
      </zip>
      <zip zipfile="${issue.dir}/SaxonPE${versionh}J.zip">
        <fileset dir="${product.dir}/pej"/>
      </zip>                     
	  <zip zipfile="${issue.dir}/SaxonEE${versionh}J.zip">
        <fileset dir="${product.dir}/eej"/>
      </zip>                     
     </target>

    <target name="maven" description="Build files ready for maven" depends="compile-hej">
        <mkdir dir="product.dir/maven" />
       <taskdef name="jarjar" classname="com.tonicsystems.jarjar.JarJarTask" classpath="../lib/jarjar-1.1.jar"/>
       <jar basedir="${temp-src-prep-hej.dir}" compress="true" jarfile="${product.dir}/maven/Saxon-HE-${version.maven}-sources.jar">
           <include name="net/**/*.java"/>
           <include name="net/**/package.html"/>
      </jar>

      <jar basedir="${classes-j.dir}" compress="${build.compress}" jarfile="${product.dir}/maven/Saxon-HE-${version.maven}.jar">
            <include name="net/**/*.class"/>
            <exclude name="net/sf/saxon/option/**/*.class"/>
            <!--<exclude name="**/javax/**/*.class"/>
            <exclude name="**/xpath/**/*.class"/>
            <exclude name="**/xqj/**/*.class"/>-->
            <include name="javax/xml/xquery/*.class"/>
            <include name="META-INF/**"/>
            <manifest>
                <attribute name="Project-Name" value="Saxon-HE"/>
                <attribute name="Main-Class" value="net.sf.saxon.Transform"/>
            </manifest>
            <metainf dir="${services.dir}/saxon9he/META-INF"/>
            <!--<metainf dir="${services.dir}/saxon9-xpath/META-INF"/>-->
            <!--
            <service type="javax.xml.transform.TransformerFactory"
                provider="net.sf.saxon.TransformerFactoryImpl"/>
            -->
        </jar>

        <jar basedir="${development-data.dir}" compress="${build.compress}" jarfile="${product.dir}/maven/Saxon-HE-${version.maven}.jar" update="true">
            <include name="**"/>
        </jar>


        <jar basedir="${classes-j.dir}" compress="true" jarfile="${product.dir}/maven/Saxon-HE-${version.maven}-compressed.jar">
            <include name="net/**/*.class"/>
            <exclude name="net/sf/saxon/option/**/*.class"/>
            <!--<exclude name="**/javax/**/*.class"/>
            <exclude name="**/xpath/**/*.class"/>
            <exclude name="**/xqj/**/*.class"/>-->
            <include name="javax/xml/xquery/*.class"/>
            <include name="META-INF/**"/>
            <manifest>
                <attribute name="Project-Name" value="Saxon-HE"/>
                <attribute name="Main-Class" value="net.sf.saxon.Transform"/>
            </manifest>
            <metainf dir="${services.dir}/saxon9he/META-INF"/>
            <!--<metainf dir="${services.dir}/saxon9-xpath/META-INF"/>-->
            <!--
            <service type="javax.xml.transform.TransformerFactory"
                provider="net.sf.saxon.TransformerFactoryImpl"/>
            -->
        </jar>

                <!-- add data files -->
        <jar basedir="${development-data.dir}" compress="true" jarfile="${product.dir}/maven/Saxon-HE-${version.maven}-compressed.jar" update="true">
            <include name="**"/>
        </jar>
    </target>
       
    
</project>
